<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>French Fairy Tale Quest ‚Äî Learn the Words!</title>
<style>
  :root{
    --bg:#0f1226; --card:#181c3a; --ink:#e8ecff; --muted:#aab1ff; --accent:#5cf2d6; --accent2:#ffdd57; --good:#6cf28b; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    background: radial-gradient(1200px 600px at 20% -10%, #253175 0%, transparent 60%),
                radial-gradient(900px 700px at 100% 0%, #2a215a 0%, transparent 60%),
                var(--bg);
    color:var(--ink);
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
  }
  .app{max-width:1000px; width:100%; }
  header{
    display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:14px;
  }
  h1{font-size: clamp(22px, 3vw, 32px); margin:0; letter-spacing:.3px}
  .pill{
    background:linear-gradient(135deg, #2a2f63, #232852); color:var(--ink); border:1px solid #3a448a;
    padding:8px 12px; border-radius:999px; font-weight:600; box-shadow:0 10px 24px rgba(0,0,0,.18) inset, 0 0 0 1px rgba(255,255,255,.04) inset;
  }
  .wrap{display:grid; grid-template-columns: 1.15fr .85fr; gap:16px}
  @media (max-width:960px){ .wrap{grid-template-columns:1fr} }

  .card{
    background:linear-gradient(175deg, #1b2044, #15193a 60%); border:1px solid #2b356d; border-radius:18px; padding:16px;
    box-shadow: 0 8px 28px rgba(0,0,0,.35), 0 2px 0 1px rgba(255,255,255,.03) inset;
  }
  .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between}
  .toolbar .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}

  button, .btn{
    appearance:none; border:1px solid #33408e; background:linear-gradient(180deg, #2a3271, #242a5b);
    color:var(--ink); padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
    box-shadow:0 8px 18px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.04) inset; transition:.15s transform,.2s filter,.2s background;
  }
  button:hover{ filter:brightness(1.05) }
  button:active{ transform:translateY(2px) }

  .mode{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
  @media (max-width:540px){ .mode{grid-template-columns:1fr 1fr} }

  .statbar{
    display:grid; grid-template-columns: 1.3fr .7fr; gap:10px; margin:10px 0 14px;
  }
  @media (max-width:540px){ .statbar{grid-template-columns:1fr} }
  .progress, .health{
    background:#10133a; border:1px solid #2b356d; border-radius:12px; overflow:hidden; height:14px; position:relative;
  }
  .progress .fill{background:linear-gradient(90deg, var(--accent), #70f7ff); height:100%; width:0%}
  .health .fill{background:linear-gradient(90deg, #ff8a8a, var(--bad)); height:100%; width:100%}
  .meta{display:flex; gap:10px; flex-wrap:wrap; font-weight:700; color:var(--muted); font-size:14px}

  /* QUIZ */
  .prompt{
    font-size: clamp(18px, 3.2vw, 26px); margin:10px 0 14px; font-weight:800;
    background:linear-gradient(90deg, #fff, #c7d2ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .options{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width:680px){ .options{grid-template-columns:1fr} }
  .option{
    background:linear-gradient(170deg, #2b2f6d, #24295c); border:1px solid #3d4796; border-radius:14px; padding:14px;
    font-size:18px; font-weight:700; cursor:pointer; text-align:left; position:relative; isolation:isolate;
  }
  .option.correct{outline:2px solid var(--good); background:linear-gradient(170deg, #254b37, #203f2f)}
  .option.wrong{outline:2px solid var(--bad); background:linear-gradient(170deg, #4a2331, #3b1c28)}
  .sublabel{display:block; font-size:12px; font-weight:700; opacity:.75}
  .speak{
    position:absolute; right:10px; top:10px; background:#0f143d; border:1px solid #3b4692; border-radius:10px; padding:6px 8px; font-weight:900;
  }

  /* MATCH GAME */
  .grid{display:grid; gap:10px; grid-template-columns:repeat(4,1fr)}
  @media (max-width:680px){ .grid{grid-template-columns:repeat(2,1fr)} }
  .tile{
    padding:14px; min-height:72px; display:flex; align-items:center; justify-content:center; text-align:center;
    border-radius:14px; border:1px solid #3b4692; background:linear-gradient(180deg, #202861, #1a204a); cursor:pointer; font-weight:800;
  }
  .tile.revealed{background:linear-gradient(180deg, #264e3a, #213e30); border-color:#2e9e74}
  .tile.solved{background:linear-gradient(180deg, #2a2f6d, #232852); border-color:#4650a5; opacity:.6; cursor:default}

  .footer{display:flex; gap:8px; flex-wrap:wrap; justify-content:space-between; align-items:center; margin-top:12px; color:var(--muted)}
  .tiny{font-size:12px}
  .big{font-size:18px; font-weight:900}

  /* Confetti canvas */
  #fx{position:fixed; inset:0; pointer-events:none}
</style>
</head>
<body>
<canvas id="fx"></canvas>
<div class="app">
  <header>
    <h1>üßô‚Äç‚ôÇÔ∏è French Fairy Tale Quest</h1>
    <div class="pill" id="motto">Collect stars by answering correctly. Boss levels are matching games.</div>
  </header>

  <div class="wrap">
    <!-- LEFT: Game area -->
    <section class="card" id="game">
      <div class="toolbar">
        <div class="row">
          <button id="modeQuiz" title="Multiple choice quiz">üéØ Quiz</button>
          <button id="modeMatch" title="Memory match with pairs">üß© Match</button>
          <button id="toggleDir" title="Switch direction (French ‚Üî English)">üîÑ FR ‚Üí EN</button>
          <button id="hearPrompt" title="Hear the prompt out loud">üîä Speak</button>
        </div>
        <div class="row">
          <button id="reset">‚Üª Reset</button>
        </div>
      </div>

      <div class="statbar">
        <div class="progress" title="Quest progress"><div class="fill" id="pFill"></div></div>
        <div class="health" title="Hearts"><div class="fill" id="hFill"></div></div>
      </div>
      <div class="meta" id="meta"></div>

      <div id="quizArea" style="display:block">
        <div class="prompt" id="prompt">Ready?</div>
        <div class="options" id="options"></div>
      </div>

      <div id="matchArea" style="display:none">
        <div class="prompt" id="matchLabel">Find the matching pairs</div>
        <div class="grid" id="grid"></div>
      </div>

      <div class="footer">
        <div class="big">‚≠ê Stars: <span id="stars">0</span></div>
        <div>Streak: <span id="streak">0</span> ¬∑ Misses left: <span id="misses">3</span></div>
        <div class="tiny">Tip: tap the little speaker on any answer to hear it.</div>
      </div>
    </section>

    <!-- RIGHT: Study & review -->
    <aside class="card">
      <h3 style="margin-top:0">üìö Study List</h3>
      <p class="tiny" style="margin-top:-6px">Tap a word to hear it. Toggle below to flip columns.</p>
      <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap">
        <button id="flipTable">Flip Columns</button>
        <button id="exportMistakes">Export mistakes</button>
      </div>
      <div id="table"></div>
    </aside>
  </div>
</div>

<script>
/* =========================
   DATA: Words from the test
   ========================= */
const entries = [
  // Column set A (left two columns French ‚Üí English)
  {fr:"Carrosse", en:"Carriage"},
  {fr:"Citrouille", en:"Pumpkin"},
  {fr:"Pantoufle", en:"Slipper"},
  {fr:"Ch√¢teau", en:"Castle"},
  {fr:"Minuit", en:"Midnight"},
  {fr:"Perdre", en:"To Lose"},
  {fr:"Vilaines", en:"Evil"},
  {fr:"Bal", en:"A Ball/Dance"},
  {fr:"Baguette Magique", en:"Wand"},
  {fr:"Toujours", en:"Always"},
  {fr:"Panier", en:"Basket"},
  {fr:"Rencontre", en:"To meet"},
  {fr:"Sourire", en:"Smile"},
  {fr:"Vieille", en:"Old"},
  {fr:"Tout √† coup", en:"Suddenly"},
  {fr:"Chasseur", en:"Hunter"},
  {fr:"Apporter", en:"To bring"},
  {fr:"Douce", en:"Sweet"},
  {fr:"Sauver", en:"To save"},
  {fr:"Repas", en:"Meal"},
  // Column set B (right two columns French ‚Üí English)
  {fr:"Princesse", en:"Princess"},
  {fr:"Aiguille", en:"Needle"},
  {fr:"Toucher", en:"To touch"},
  {fr:"Brave", en:"Brave"},
  {fr:"Silencieux", en:"Silence"},
  {fr:"R√©veiller", en:"To Wake up"},
  {fr:"√âpaisse", en:"Thick"},
  {fr:"Endormie", en:"Asleep"},
  {fr:"Fort", en:"Strong"},
  {fr:"Heureux", en:"Happy"},
  {fr:"Mer", en:"Sea"},
  {fr:"Queue", en:"Tail"},
  {fr:"Roi", en:"King"},
  {fr:"Bleue Claire", en:"Light Blue"},
  {fr:"Sir√®ne", en:"Mermaid"},
  {fr:"Bateau", en:"Boat"},
  {fr:"D√©couvrir", en:"To discover"},
  {fr:"Oc√©an", en:"Ocean"},
  {fr:"Voix", en:"Voice"},
  {fr:"Jambes", en:"Legs"}
];

/* ========= Helpers ========= */
const byId = id => document.getElementById(id);
const rand = n => Math.floor(Math.random()*n);
const copy = x => JSON.parse(JSON.stringify(x));
const speak = (txt, lang="fr-FR") => {
  if (!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(txt);
  u.lang = lang;
  u.rate = 0.95;
  u.pitch = 1.0;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
};

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=rand(i+1); [a[i],a[j]]=[a[j],a[i]]; } return a; }

/* ======= State ======= */
let dir = "FR2EN";           // FR2EN or EN2FR
let mode = "QUIZ";           // QUIZ or MATCH
let stars = 0;
let streak = 0;
let misses = 3;
let asked = 0;
let progress = 0;            // 0..1
let pool = [];               // active learning pool with weights
let mistakes = [];           // for export

/* ======= Init ======= */
function initPool(){
  // Weight mistakes higher so they reappear more
  pool = entries.map(e => ({...e, weight:1}));
}
initPool();

/* ======= UI wiring ======= */
byId("modeQuiz").onclick = ()=>switchMode("QUIZ");
byId("modeMatch").onclick = ()=>switchMode("MATCH");
byId("toggleDir").onclick = ()=>{ dir = dir==="FR2EN" ? "EN2FR" : "FR2EN"; updateMeta(); next(); };
byId("reset").onclick = ()=>resetGame();
byId("hearPrompt").onclick = ()=> {
  const node = byId("prompt");
  const txt = node?.dataset?.say || node?.textContent || "";
  const lang = dir==="FR2EN" ? "fr-FR" : "en-US";
  speak(txt, lang);
};
byId("flipTable").onclick = ()=> renderTable(true);
byId("exportMistakes").onclick = exportMistakes;

function resetGame(){
  stars=0; streak=0; misses=3; asked=0; progress=0; mistakes.length=0; initPool();
  updateStats(); switchMode("QUIZ");
}

/* ======= Stats & HUD ======= */
function updateStats(){
  byId("stars").textContent = stars;
  byId("streak").textContent = streak;
  byId("misses").textContent = misses;
  byId("pFill").style.width = (progress*100).toFixed(1)+"%";
  byId("hFill").style.width = (Math.max(0, misses)/3*100)+"%";
}
function updateMeta(){
  const rounds = 20; // after 20 quiz rounds progress fills
  byId("meta").textContent =
    `Mode: ${mode==="QUIZ"?"Quiz":"Match"} ¬∑ Direction: ${dir==="FR2EN"?"FR ‚Üí EN":"EN ‚Üí FR"} ¬∑ Round ${asked+1}`;
  byId("toggleDir").textContent = dir==="FR2EN" ? "üîÑ FR ‚Üí EN" : "üîÑ EN ‚Üí FR";
  byId("motto").textContent = mode==="QUIZ"
    ? "Answer to earn stars. Every 5 correct triggers a matching boss."
    : "Clear the board by finding French ‚Üî English pairs.";
}

/* ======= Quiz mode ======= */
function weightedPick(){
  const total = pool.reduce((s,e)=>s+e.weight,0);
  let r = Math.random()*total;
  for(const e of pool){ r -= e.weight; if(r<=0) return e; }
  return pool[0];
}
function makeOptions(correct, k=4){
  const opts = new Set([correct]);
  while(opts.size<k){
    const random = entries[rand(entries.length)];
    const text = dir==="FR2EN" ? random.en : random.fr;
    opts.add(text);
  }
  return shuffle([...opts]);
}
function renderQuiz(){
  const item = weightedPick();
  const q = dir==="FR2EN" ? item.fr : item.en;
  const a = dir==="FR2EN" ? item.en : item.fr;

  byId("prompt").textContent = `Translate: ${q}`;
  byId("prompt").dataset.say = q;
  const wrap = byId("options"); wrap.innerHTML = "";

  makeOptions(a, 4).forEach(opt=>{
    const btn = document.createElement("button");
    btn.className = "option";
    btn.innerHTML = `<span>${opt}</span> <button class="speak" aria-label="speak">üîä</button>
                     <span class="sublabel"></span>`;
    btn.onclick = (ev)=>{
      if (ev.target && ev.target.closest(".speak")) {
        speak(opt, dir==="FR2EN" ? "en-US" : "fr-FR");
        ev.stopPropagation(); return;
      }
      check(opt, a, item, btn);
    };
    wrap.appendChild(btn);
  });

  // hint under one option with the same first letter
  for(const el of wrap.children){
    const txt = el.querySelector("span").textContent.trim();
    if (txt[0] === a[0]) { el.querySelector(".sublabel").textContent = "Hint: same first letter"; break; }
  }
}
function check(choice, answer, item, btnNode){
  asked++; updateMeta();
  const all = [...document.querySelectorAll(".option")];
  all.forEach(b => b.disabled = true);

  if(choice === answer){
    btnNode.classList.add("correct");
    streak++; stars += 2 + Math.floor(streak/3); // reward streaks
    // make the chosen word less likely for a while
    item.weight = Math.max(.3, item.weight*0.6);
    celebrate();
  }else{
    btnNode.classList.add("wrong");
    for(const el of all){ if(el.textContent.trim().startsWith(answer)) el.classList.add("correct"); }
    streak = 0; misses--;
    // increase weight so it comes back soon
    item.weight = Math.min(5, item.weight*1.8);
    mistakes.push({q: dir==="FR2EN"?item.fr:item.en, a:answer, when:new Date().toISOString()});
    flash(byId("game"), "shake");
  }

  progress = Math.min(1, asked/20);
  updateStats();

  // boss every 5 correct answers
  if (stars && stars % 10 === 0){
    setTimeout(()=>{ switchMode("MATCH"); }, 600);
  }else{
    setTimeout(next, 700);
  }

  if (misses <= 0){
    setTimeout(()=>{
      alert("All hearts lost. Restarting quest.");
      resetGame();
    }, 250);
  }
}

/* ======= Match mode ======= */
let matchDeck=[], matchOpen=[], matchSolved=0;
function buildDeck(){
  // pick 6 random pairs from entries
  const sample = shuffle(copy(entries)).slice(0, 6);
  matchDeck = [];
  for(const it of sample){
    matchDeck.push({id: it.fr+"|F", text: it.fr, key: it.en, lang:"fr", solved:false});
    matchDeck.push({id: it.fr+"|E", text: it.en, key: it.en, lang:"en", solved:false});
  }
  shuffle(matchDeck);
}
function renderMatch(){
  const grid = byId("grid"); grid.innerHTML="";
  matchOpen=[]; matchSolved=0;
  buildDeck();
  matchDeck.forEach(card=>{
    const d = document.createElement("button");
    d.className="tile";
    d.textContent = "‚ùì";
    d.dataset.id = card.id;
    d.onclick = ()=>{
      if(card.solved || matchOpen.includes(card) || matchOpen.length===2) return;
      d.classList.add("revealed");
      d.textContent = card.text;
      speak(card.text, card.lang==="fr"?"fr-FR":"en-US");
      matchOpen.push(card);

      if(matchOpen.length===2){
        const [a,b] = matchOpen;
        const aDom = [...grid.children].find(x=>x.dataset.id===a.id);
        const bDom = [...grid.children].find(x=>x.dataset.id===b.id);
        if(a.key === b.key && a.id!==b.id){
          // solved
          setTimeout(()=>{
            a.solved = b.solved = true;
            aDom.className="tile solved"; bDom.className="tile solved";
            aDom.textContent = a.text; bDom.textContent = b.text;
            matchOpen.length=0; matchSolved+=2;
            stars += 5; streak += 2; updateStats(); celebrateSmall();
            if(matchSolved === matchDeck.length){
              setTimeout(()=>{
                switchMode("QUIZ");
              }, 700);
            }
          }, 250);
        }else{
          // mismatch
          streak = 0; misses--; updateStats(); flash(byId("game"), "shake");
          setTimeout(()=>{
            aDom.classList.remove("revealed"); bDom.classList.remove("revealed");
            aDom.textContent="‚ùì"; bDom.textContent="‚ùì"; matchOpen.length=0;
            if(misses<=0){ alert("All hearts lost. Restarting quest."); resetGame(); }
          }, 650);
        }
      }
    };
    grid.appendChild(d);
  });
}

/* ======= Mode switch & next ======= */
function switchMode(nextMode){
  mode = nextMode;
  byId("quizArea").style.display = mode==="QUIZ" ? "block" : "none";
  byId("matchArea").style.display = mode==="MATCH" ? "block" : "none";
  updateMeta();
  if(mode==="QUIZ") renderQuiz(); else renderMatch();
}
function next(){
  if(mode!=="QUIZ") return;
  renderQuiz();
}

/* ======= Study table ======= */
let tableFlip=false;
function renderTable(flipToggle=false){
  if(flipToggle) tableFlip=!tableFlip;
  const host = byId("table"); host.innerHTML="";
  const t = document.createElement("table");
  t.style.width="100%"; t.style.borderCollapse="separate"; t.style.borderSpacing="0 6px";
  entries.forEach(e=>{
    const tr = document.createElement("tr");
    const a = document.createElement("td");
    const b = document.createElement("td");
    a.style.padding="8px 10px"; b.style.padding="8px 10px";
    a.style.background="#141947"; b.style.background="#141947";
    a.style.border="1px solid #2b356d"; b.style.border="1px solid #2b356d";
    a.style.borderRadius="10px 0 0 10px"; b.style.borderRadius="0 10px 10px 0";
    a.style.fontWeight="800"; b.style.fontWeight="700";
    a.style.width="48%"; b.style.width="52%";
    if(!tableFlip){ a.textContent=e.fr; b.textContent=e.en; }
    else { a.textContent=e.en; b.textContent=e.fr; }
    a.onclick=()=>speak(a.textContent, tableFlip?"en-US":"fr-FR");
    b.onclick=()=>speak(b.textContent, tableFlip?"fr-FR":"en-US");
    tr.appendChild(a); tr.appendChild(b); t.appendChild(tr);
  });
  host.appendChild(t);
}
renderTable();

/* ======= Effects: confetti & flash ======= */
const fx = byId("fx"); const ctx = fx.getContext("2d");
function resizeFx(){ fx.width = innerWidth; fx.height = innerHeight; }
addEventListener("resize", resizeFx); resizeFx();

let confetti = [];
function celebrateSmall(){ burst(18, 9); }
function celebrate(){ burst(36, 12); }
function burst(n=30, speed=10){
  for(let i=0;i<n;i++){
    confetti.push({
      x: innerWidth*0.5 + (Math.random()*120-60),
      y: innerHeight*0.2 + (Math.random()*30-15),
      vx: (Math.random()-0.5)*speed,
      vy: Math.random()*-speed - 2,
      g: .25+Math.random()*.2,
      s: 4+Math.random()*4,
      a: 1,
      hue: Math.floor(Math.random()*360)
    });
  }
}
function tick(){
  ctx.clearRect(0,0,fx.width,fx.height);
  confetti.forEach(p=>{
    p.vy += p.g; p.x += p.vx; p.y += p.vy; p.a -= 0.01;
  });
  confetti = confetti.filter(p=>p.a>0 && p.y<innerHeight+20);
  confetti.forEach(p=>{
    ctx.globalAlpha = Math.max(0, p.a);
    ctx.fillStyle = `hsl(${p.hue} 90% 60%)`;
    ctx.fillRect(p.x, p.y, p.s, p.s);
  });
  requestAnimationFrame(tick);
}
tick();

function flash(el, cls){
  el.style.animation = "shake .32s linear";
  setTimeout(()=>{ el.style.animation = "" }, 340);
}
const style = document.createElement("style");
style.textContent = `
@keyframes shake {
  0%{ transform:translateX(0) } 20%{ transform:translateX(-6px) }
  40%{ transform:translateX(6px) } 60%{ transform:translateX(-4px) }
  80%{ transform:translateX(4px) } 100%{ transform:translateX(0) }
}`; document.head.appendChild(style);

/* ======= Start ======= */
updateMeta(); updateStats(); renderQuiz();

/* ======= Export mistakes ======= */
function exportMistakes(){
  if(!mistakes.length){ alert("Nice. No mistakes to export."); return; }
  const lines = mistakes.map(m=>`${m.when}\t${m.q}\t${m.a}`);
  const blob = new Blob(["When\tPrompt\tAnswer\n", ...lines].join("\n"), {type:"text/tab-separated-values"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "french-mistakes.tsv"; a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>

